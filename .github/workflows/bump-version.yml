name: Bump version + create anchor
on:
  create:
    branches: [ 'release/**', 'hotfix/**' ]
permissions:
  contents: write

jobs:
  bump-and-anchor:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with: { fetch-depth: 0 }
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '24'

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Set Maven version from branch and create base tag
        shell: bash
        run: |
          BRANCH="${GITHUB_REF_NAME}"            # release/1.3.0 ou hotfix/1.3.1
          VERSION="${BRANCH#*/}"                     # 1.3.0
          KIND="${BRANCH%%/*}"                   # release|hotfix
          mvn -q versions:set -DnewVersion="$VERSION" -DprocessAllModules=true -DgenerateBackupPoms=false
          mvn -q versions:commit
          git add -A
          git commit -m "chore: set version $VERSION from $BRANCH" || echo "no changes"
          BASE_TAG="$KIND-base/$VERSION"
          git tag -a "$BASE_TAG" -m "base of $BRANCH at creation"
          git push origin HEAD:"$BRANCH"
          git push origin "$BASE_TAG"
