name: Create Release Anchor
on:
  create:
    branches: [ 'release/**', 'hotfix/**' ]
permissions:
  contents: write

jobs:
  create-anchor-and-changelog:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with: { fetch-depth: 0 }

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '24'

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Sync pom.xml version and create anchor
        shell: bash
        run: |
          BRANCH="${GITHUB_REF_NAME}"
          BRANCH_VERSION="${BRANCH#*/}"
          KIND="${BRANCH%%/*}"
          
          # Verifica vers√£o atual do pom.xml
          CURRENT_POM_VERSION=$(mvn -q -DforceStdout -Dexpression=project.version -DnonRecursive=true help:evaluate 2>/dev/null)
          
          echo "üè∑Ô∏è Branch: $BRANCH"
          echo "üìã Expected version: $BRANCH_VERSION" 
          echo "üìÑ Current pom.xml version: $CURRENT_POM_VERSION"
          
          # Se as vers√µes n√£o coincidem, atualiza o pom.xml
          if [[ "$CURRENT_POM_VERSION" != "$BRANCH_VERSION" ]]; then
            echo "üîÑ Synchronizing pom.xml version to match branch..."
          
            mvn -q versions:set -DnewVersion="$BRANCH_VERSION" -DprocessAllModules=true -DgenerateBackupPoms=false
            mvn -q versions:commit
          
            git add pom.xml
            git commit -m "chore: sync version to $BRANCH_VERSION [skip-version]

            - Branch: $BRANCH
            - Updated pom.xml from $CURRENT_POM_VERSION to $BRANCH_VERSION
            - This establishes the base version for incremental releases"
          
            echo "‚úÖ Version synchronized: $CURRENT_POM_VERSION ‚Üí $BRANCH_VERSION"
          else
            echo "‚úÖ Version already matches: $BRANCH_VERSION"
          fi
          
          # Cria tag √¢ncora AP√ìS poss√≠vel commit de sincroniza√ß√£o
          BASE_TAG="$KIND-base/$BRANCH_VERSION"
          
          echo "üéØ Creating anchor tag: $BASE_TAG"
          git tag -a "$BASE_TAG" -m "Anchor for $BRANCH at creation

          Base version: $BRANCH_VERSION
          This tag marks the starting point for incremental versioning."

      - name: Generate initial changelog
        uses: TriPSs/conventional-changelog-action@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          preset: angular
          # calcular desde a √¢ncora: release-base/ ou hotfix-base/
          tag-prefix: ${{ startsWith(github.ref_name, 'release/') && 'release-base/' || 'hotfix-base/' }}
          output-file: CHANGELOG.md
          skip-bump: 'true'
          skip-tag: 'true'
          skip-version-file: 'true'
          skip-commit: 'true'     # impede commit "chore(release): v ..."
          skip-on-empty: 'true'   # n√£o falha se n√£o houver mudan√ßas

      - name: Commit and push everything
        shell: bash
        run: |
          BRANCH="${GITHUB_REF_NAME}"
          KIND="${BRANCH%%/*}"
          BRANCH_VERSION="${BRANCH#*/}"
          BASE_TAG="$KIND-base/$BRANCH_VERSION"
          
          # Adiciona changelog se foi gerado
          git add CHANGELOG.md || true
          
          # Commit do changelog inicial (se houver)
          if ! git diff --cached --quiet; then
            git commit -m "docs(changelog): initial changelog for $BRANCH [skip-version]"
            echo "üìù Initial changelog created"
          fi
          
          # Push da branch e da tag
          git push origin HEAD:"$BRANCH"
          git push origin "$BASE_TAG"
          
          echo "üöÄ Setup completed successfully!"
          echo "   - Branch: $BRANCH"
          echo "   - Base version: $BRANCH_VERSION" 
          echo "   - Anchor tag: $BASE_TAG"
          echo "   - Initial changelog: Created"
